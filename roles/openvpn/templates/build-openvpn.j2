#!/bin/bash
# Export OpenVPN environment
. {{ easy_rsa_dir }}/vars

# Clean all 
if [ "$KEY_DIR" ]; then
    rm -rf "$KEY_DIR"
    mkdir "$KEY_DIR" && \
        chmod go-rwx "$KEY_DIR" && \
        touch "$KEY_DIR/index.txt" && \
        echo 01 >"$KEY_DIR/serial"
fi

# Generate dhparam
$OPENSSL dhparam -out ${KEY_DIR}/dh${KEY_SIZE}.pem ${KEY_SIZE}

# Build CA Certificated
$PKITOOL --batch --initca

# Build server key
$PKITOOL --batch --server {{ server_name }}

# Generate TLS key
openvpn --genkey --secret /etc/openvpn/ta.key

# Generate crl file
$OPENSSL ca -gencrl -out /etc/openvpn/easy-rsa/keys/crl.pem -config $KEY_CONFIG

# Self remove
rm -- "$0"